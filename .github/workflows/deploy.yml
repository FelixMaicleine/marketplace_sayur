name: CI/CD - Marketplace Sayur

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build_and_test:
    name: 1. Build, Test, and Push Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend Image (Lokal)
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          load: true 
          push: false 
          tags: sayur-backend-local:test 

      - name: Build Frontend Image (Lokal untuk Tes)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          load: true 
          push: false
          tags: sayur-frontend-local:test 
          build-args: |
            # Ini BENAR untuk testing di runner
            REACT_APP_API_URL=http://localhost:5000/ 

      - name: Create .env file for testing
        run: |
          echo "DB_USER=testuser" > .env
          echo "DB_PASSWORD=testpass" >> .env
          echo "DB_NAME=testdb" >> .env
          echo "JWT_SECRET=testsecret" >> .env
          echo "REACT_APP_API_URL=http://localhost:5000/" >> .env

      - name: Start Containers via Docker Compose
        run: docker compose -f docker-compose.yml up -d

      - name: Wait for Containers to be healthy
        run: |
          echo "Menunggu 20 detik agar database dan service siap..."
          sleep 20 
          echo "Daftar container yang berjalan:"
          docker ps

      - name: Test Frontend (Port 3000)
        run: curl -f http://localhost:3000/

      - name: Test Backend (Port 5000)
        run: curl -f http://localhost:5000/

      - name: Stop Test Containers
        if: always() 
        run: docker compose -f docker-compose.yml down

      # --- TAHAP PUSH (SETELAH TES LOLOS) ---

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOKCERHUB_USERNAME }} # Perbaiki typo DOKCERHUB
          password: ${{ secrets.DOKCERHUB_TOKEN }} # Perbaiki typo DOKCERHUB

      - name: Tag and Push Backend Image (dari versi lokal)
        run: |
          docker tag sayur-backend-local:test ${{ secrets.DOKCERHUB_USERNAME }}/sayur-backend:latest # Perbaiki typo DOKCERHUB
          docker push ${{ secrets.DOKCERHUB_USERNAME }}/sayur-backend:latest # Perbaiki typo DOKCERHUB
          
      # =======================================================
      # ▼▼▼▼▼ INI BAGIAN YANG DIPERBAIKI ▼▼▼▼▼
      # =======================================================
      - name: Build and Push Frontend Image (Production)
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true # <-- Langsung push ke Docker Hub
          tags: ${{ secrets.DOKCERHUB_USERNAME }}/sayur-frontend:latest # Perbaiki typo DOKCERHUB
          build-args: |
            # INI KUNCINYA: Gunakan IP Publik untuk build 'final'
            REACT_APP_API_URL=http://34.143.168.92:5000/

  # =======================================================
  # ▼ JOB DEPLOYMENT (CD) - TIDAK BERUBAH
  # =======================================================
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_test 
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to GCP VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            git pull origin main
            
            COMPOSE_FILES="-f docker-compose.yml -f docker-compose.prod.yml"

            docker compose $COMPOSE_FILES pull
            docker compose $COMPOSE_FILES down
            docker compose $COMPOSE_FILES up -d 
            
            echo "Deployment complete!"